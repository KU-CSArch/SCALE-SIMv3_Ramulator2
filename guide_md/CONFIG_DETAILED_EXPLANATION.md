# Config 파일 상세 해석: Scratchpad, PE 크기, PE 개수

## 질문 1: Scratchpad 메모리 크기는?

### 정답: 이 3줄!

```ini
IfmapSramSzkB:    6144      ← IFMAP용 SRAM: 6,144 KB = 6 MB
FilterSramSzkB:   6144      ← FILTER용 SRAM: 6,144 KB = 6 MB
OfmapSramSzkB:    2048      ← OFMAP용 SRAM: 2,048 KB = 2 MB

총 Scratchpad SRAM: 6144 + 6144 + 2048 = 14,336 KB = 약 14 MB
```

### 메모리 구조 다이어그램

```
┌──────────────────────────────────────────────┐
│      Scratchpad SRAM (Double Buffered)      │
│                                              │
│  ┌─────────────────────────────────────────┐ │
│  │  IFMAP 버퍼 (6144 KB)                   │ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 0: 3072 KB (PE 서빙 중)      ││ │
│  │  └─────────────────────────────────────┘│ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 1: 3072 KB (Prefetch 중)    ││ │
│  │  └─────────────────────────────────────┘│ │
│  └─────────────────────────────────────────┘ │
│                                              │
│  ┌─────────────────────────────────────────┐ │
│  │  FILTER 버퍼 (6144 KB)                  │ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 0: 3072 KB (PE 서빙 중)      ││ │
│  │  └─────────────────────────────────────┘│ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 1: 3072 KB (Prefetch 중)    ││ │
│  │  └─────────────────────────────────────┘│ │
│  └─────────────────────────────────────────┘ │
│                                              │
│  ┌─────────────────────────────────────────┐ │
│  │  OFMAP 버퍼 (2048 KB)                   │ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 0: 1024 KB (Write 중)        ││ │
│  │  └─────────────────────────────────────┘│ │
│  │  ┌─────────────────────────────────────┐│ │
│  │  │ Buffer 1: 1024 KB (준비 대기)       ││ │
│  │  └─────────────────────────────────────┘│ │
│  └─────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘
```

---

## 질문 2: PE 크기는?

### 정답: 각 PE는 매우 작음 (일반적으로 1-2 KB)

#### PE 구성 (하나당):

```
각 PE (Processing Element)의 내부 구조:

┌─────────────────────────────┐
│  PE (Processing Element)    │
│                              │
│  ┌──────────────────────┐   │
│  │ Multiplier           │   │ ← 곱하기
│  │ (숫자 곱셈 회로)     │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │ Accumulator          │   │ ← 누적 저장
│  │ (결과 저장, ~100B)  │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │ Control Logic        │   │ ← 제어
│  │ (~500B)              │   │
│  └──────────────────────┘   │
│                              │
│  ┌──────────────────────┐   │
│  │ Buffer (L0 cache)    │   │ ← 매우 작은 캐시
│  │ (~1 KB)              │   │
│  └──────────────────────┘   │
│                              │
│  총 크기: ~1-2 KB            │
└─────────────────────────────┘
```

#### 각 PE의 역할:

```python
# 한 PE의 하는 일 (한 사이클에):
def pe_operation():
    """
    한 PE가 매 사이클에 하는 연산:
    result = input_a × input_b + accumulator
    """
    # 입력 받기 (SRAM에서)
    ifmap_value = receive_from_sram()
    filter_value = receive_from_sram()
    
    # MAC 연산 (Multiply-Accumulate)
    acc = self.accumulator  # 누적된 값
    result = ifmap_value * filter_value + acc
    
    # 누적 저장
    self.accumulator = result
    
    # 결과 보내기 (다른 PE나 SRAM으로)
    send_to_sram(result)
```

---

## 질문 3: PE 개수는?

### 정답: PE 배열 크기 = 256 × 256 = 65,536개

```ini
ArrayHeight:    256         ← PE 배열의 세로
ArrayWidth:     256         ← PE 배열의 가로

총 PE 개수: 256 × 256 = 65,536개
```

### PE 배열 구조 시각화

```
PE 배열 (256 × 256):

     [0]  [1]  [2] ... [255]
[0]  PE   PE   PE  ...  PE
[1]  PE   PE   PE  ...  PE
[2]  PE   PE   PE  ...  PE
...
[255]PE   PE   PE  ...  PE

각 칸 하나 = 하나의 PE

PE(i, j) = i번째 행, j번째 열의 PE

예:
PE(0, 0): 왼쪽 위 PE
PE(0, 255): 오른쪽 위 PE
PE(255, 255): 오른쪽 아래 PE

모두 병렬로 동작!
```

---

## 전체 아키텍처 통합 이해

### GoogleTPU v1 (이 config 기반)

```
┌────────────────────────────────────────────────┐
│          GoogleTPU v1 아키텍처                  │
│                                                  │
│  ┌──────────────────────────────────────────┐  │
│  │   Systolic Array (PE 배열)               │  │
│  │   256 × 256 = 65,536 PE                  │  │
│  │                                          │  │
│  │   [PE][PE][PE]...[PE]                    │  │
│  │   [PE][PE][PE]...[PE]                    │  │
│  │   [PE][PE][PE]...[PE]                    │  │
│  │   ...                                     │  │
│  │   [PE][PE][PE]...[PE]                    │  │
│  │                                          │  │
│  │   각 PE는:                               │  │
│  │   - MACs/cycle: 1 (한 번에 곱 + 더하기) │  │
│  │   - 크기: ~1-2 KB                       │  │
│  └──────────────────────────────────────────┘  │
│           ↕ (데이터 흐름)                      │
│  ┌──────────────────────────────────────────┐  │
│  │   Scratchpad SRAM (메모리)               │  │
│  │   총 14 MB (3개 영역으로 분할)           │  │
│  │                                          │  │
│  │   ┌─────────────────────────────────┐  │  │
│  │   │ IFMAP SRAM: 6 MB                │  │  │
│  │   │ (Buffer 0: 3MB, Buffer 1: 3MB)  │  │  │
│  │   └─────────────────────────────────┘  │  │
│  │   ┌─────────────────────────────────┐  │  │
│  │   │ FILTER SRAM: 6 MB               │  │  │
│  │   │ (Buffer 0: 3MB, Buffer 1: 3MB)  │  │  │
│  │   └─────────────────────────────────┘  │  │
│  │   ┌─────────────────────────────────┐  │  │
│  │   │ OFMAP SRAM: 2 MB                │  │  │
│  │   │ (Buffer 0: 1MB, Buffer 1: 1MB)  │  │  │
│  │   └─────────────────────────────────┘  │  │
│  └──────────────────────────────────────────┘  │
│           ↕ (데이터 흐름, 제한된 대역폭)       │
│  ┌──────────────────────────────────────────┐  │
│  │   DRAM (Main Memory)                     │  │
│  │   대역폭: 10 GB/s (Bandwidth 설정)       │  │
│  └──────────────────────────────────────────┘  │
└────────────────────────────────────────────────┘
```

---

## 구체적 숫자로 계산

### QKT 레이어 실행 시나리오

```
Topology:
  M = 1024 (배치)
  K = 64 (입력 채널)
  N = 1024 (출력 채널)
  연산: M × N × K = 1024 × 1024 × 64 = 67,108,864 MACs

PE 배열: 256 × 256 = 65,536 PE
총 연산 능력: 65,536 MACs/cycle

필요한 사이클:
  67,108,864 / 65,536 = 1,024 cycles
  (이상적인 경우, 메모리 지연 없을 때)

메모리 요구:
  IFMAP 필요: M × K = 1024 × 64 = 65,536 개 주소
              크기: 65,536 × 4 bytes = 262 KB
  
  FILTER 필요: K × N = 64 × 1024 = 65,536 개 주소
               크기: 65,536 × 4 bytes = 262 KB
  
  OFMAP 필요: M × N = 1024 × 1024 = 1,048,576 개 주소
              크기: 1,048,576 × 4 bytes = 4 MB

SRAM으로 충분한가?
  IFMAP SRAM 6 MB > 262 KB ✓ (23배 여유)
  FILTER SRAM 6 MB > 262 KB ✓ (23배 여유)
  OFMAP SRAM 2 MB > 4 MB ✗ (부족!)
  
  → OFMAP이 부족하므로 분할 필요
```

---

## 각 설정값의 의미

### [architecture_presets]

```ini
ArrayHeight:        256      ← PE 배열의 높이
ArrayWidth:         256      ← PE 배열의 너비
                             → 총 256 × 256 = 65,536 PE

IfmapSramSzkB:      6144     ← IFMAP SRAM: 6 MB (double buffered: 3+3)
FilterSramSzkB:     6144     ← FILTER SRAM: 6 MB (double buffered: 3+3)
OfmapSramSzkB:      2048     ← OFMAP SRAM: 2 MB (double buffered: 1+1)

IfmapOffset:        0        ← 논리 주소에서 IFMAP 시작: 0
FilterOffset:       10000000 ← 논리 주소에서 FILTER 시작: 10M
OfmapOffset:        20000000 ← 논리 주소에서 OFMAP 시작: 20M

Dataflow:           ws       ← Weight Stationary (가중치 고정)
Bandwidth:          10       ← DRAM 대역폭: 10 GB/s
```

### [layout] - SRAM 구조

```ini
IfmapSRAMBankNum:   10       ← IFMAP SRAM을 10개 뱅크로 분할
                              (병렬 접근 가능)
IfmapSRAMBankPort:  2        ← 각 뱅크에 2개 포트 (읽기/쓰기)
IfmapSRAMBankBandwidth: 10   ← 각 뱅크 대역폭: 10

FilterSRAMBankNum:  10       ← FILTER SRAM: 10개 뱅크
FilterSRAMBankPort: 2        ← 각 뱅크: 2개 포트
FilterSRAMBankBandwidth: 10  ← 각 뱅크 대역폭: 10
```

### 메모리 뱅크 구조

```
IFMAP SRAM (6 MB):
┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│ B0  │ B1  │ B2  │ B3  │ B4  │ B5  │ B6  │ B7  │ B8  │ B9  │
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
 600K  600K  600K  600K  600K  600K  600K  600K  600K  600K

각 뱅크가 2개 포트 → 동시에 2개 주소 접근 가능
→ PE(0,0), PE(0,1), ..., PE(0,9)가 동시에 다른 뱅크에 접근 가능
```

---

## 최종 정리

### 3가지 핵심 질문 답변

| 질문 | 답변 | 위치 |
|------|------|------|
| Scratchpad 크기? | 6+6+2 = 14 MB | IfmapSramSzkB 등 |
| PE 크기? | 1-2 KB (각 PE당) | Datasheet (config에 없음) |
| PE 개수? | 256 × 256 = 65,536 | ArrayHeight × ArrayWidth |

### 메모리 용량 정보

```
Scratchpad SRAM:
  IFMAP: 6 MB → 1,572,864 주소 가능 (4bytes/주소)
  FILTER: 6 MB → 1,572,864 주소 가능
  OFMAP: 2 MB → 524,288 주소 가능
  
DRAM:
  크기: 무제한 (이 config에 명시 안함)
  대역폭: 10 GB/s (주요 병목)
```

### 성능 특성

```
Peak Performance:
  PE 개수: 65,536
  연산/PE: 1 MAC/cycle
  → 최대: 65,536 MACs/cycle
  
  시간 계산: 1024 × 1024 × 64 MACs
           ÷ 65,536 MACs/cycle
           = 1,024 cycles (이상적)

실제 성능은 메모리 대역폭에 제한됨:
  DRAM 대역폭: 10 GB/s
  SRAM 대역폭: 더 높음 (double buffering)
```
